{% extends 'base.html.twig' %}

{% block title %}{{ movie.title }} – Cinéphoria{% endblock %}

{% block body %}
    <section
            class="relative bg-cover bg-center min-h-[80vh] pt-32 pb-16 text-white"
            style="background-image:url('{{ asset('pictures/hero/' ~ movie.heroImage) }}')"
    >
        <!-- Overlay sombre + blur -->
        <div class="absolute inset-0 bg-gradient-to-b from-black/40 to-black/70 backdrop-blur-sm"></div>

        <div class="relative z-10 container mx-auto px-4 flex flex-col lg:flex-row gap-8">
            <!-- Affiche du film -->
            <img
                    class="w-60 h-[360px] rounded-xl shadow-2xl flex-shrink-0"
                    src="{{ asset('pictures/films/' ~ movie.posterUrl) }}"
                    alt="{{ movie.title }}"
            >

            <!-- Métadonnées -->
            <div class="flex-1 space-y-4">
                <h1 class="text-4xl font-bold">{{ movie.title }}</h1>

                {# Durée formatée en HH:MM:SS #}
                {% set mins = movie.duration %}
                {% set h = mins // 60 %}
                {% set m = mins % 60 %}
                {% set fmt = '%02d:%02d:00'|format(h, m) %}

                <ul class="space-y-2 text-base">
                    <li class="flex items-center gap-2">
                        <i data-lucide="film" class="w-5 h-5"></i>
                        <strong>Genres:</strong> {{ movie.genre|join(', ') }}
                    </li>
                    <li class="flex items-center gap-2">
                        <i data-lucide="globe" class="w-5 h-5"></i>
                        <strong>Languages:</strong> {{ movie.language|join(', ') }}
                    </li>
                    <li class="flex items-center gap-2">
                        <i data-lucide="calendar-days" class="w-5 h-5"></i>
                        <strong>Release Date:</strong> {{ movie.releaseDate|date('F j, Y') }}
                    </li>
                    <li class="flex items-center gap-2">
                        <i data-lucide="clock" class="w-5 h-5"></i>
                        <strong>Duration:</strong> {{ mins }} min ({{ fmt }})
                    </li>
                    <li class="flex items-center gap-2">
                        <i data-lucide="shield-check" class="w-5 h-5"></i>
                        <strong>Age Rating:</strong> {{ movie.ageRating }}
                    </li>
                    {% if movie.isFavorite %}
                        <li class="flex items-center gap-2 text-yellow-400">
                            <i data-lucide="star" class="w-5 h-5"></i>
                            <strong>Marked as Favorite</strong>
                        </li>
                    {% endif %}
                </ul>

                <p class="prose prose-invert">
                    {{ movie.description|striptags }}
                </p>
            </div>
        </div>

        <!-- Selector + Slider + Showtimes -->
        <div class="relative z-10 container mx-auto px-4 mt-12 space-y-6">
            <!-- Barre de sélection de cinéma -->
            <div class="flex justify-center items-center gap-4">
                <label for="cinemaSelect" class="font-semibold text-lg">Sélectionnez un cinéma:</label>
                <div class="relative">
                    <select
                            id="cinemaSelect"
                            class="inline-block px-4 py-2 border border-gray-300 rounded-lg bg-white text-gray-800
                         focus:outline-none focus:ring-2 focus:ring-blue-600 transition"
                            onchange="filterByCinema(this.value)"
                    >
                        <option value="">-- Tous les cinémas --</option>
                        {% for cinema in cinemas %}
                            <option value="{{ cinema.id }}">{{ cinema.name }} – {{ cinema.city }}</option>
                        {% endfor %}
                    </select>
                    <i data-lucide="chevron-down"
                       class="pointer-events-none absolute top-1/2 right-3 w-4 h-4 text-gray-600 -translate-y-1/2">
                    </i>
                </div>
            </div>

            <!-- Slider de dates -->
            <div class="flex items-center justify-center gap-3 overflow-x-auto no-scrollbar px-2 py-2 bg-black/30 rounded-xl">
                {% set seen = [] %}
                {% for st in showtimes %}
                    {% set dayKey = st.date|date('Y-m-d') %}
                    {% set dayFmt = st.date|date('D d M') %}
                    {% if dayKey not in seen %}
                        {% set seen = seen|merge([dayKey]) %}
                        <button
                                class="flex-shrink-0 px-4 py-2 bg-white text-gray-800 rounded-xl font-semibold
                             hover:bg-blue-600 hover:text-white transition"
                                onclick="filterByDate('{{ dayKey }}')"
                        >
                            {{ dayFmt }}
                        </button>
                    {% endif %}
                {% endfor %}
                <button
                        class="flex-shrink-0 px-3 py-2 bg-white/90 text-gray-600 rounded-xl hover:bg-blue-600 hover:text-white transition
                     flex items-center gap-2"
                        aria-label="Ouvrir le calendrier"
                >
                    <i data-lucide="calendar" class="w-5 h-5"></i>
                    <span class="hidden sm:inline">Calendrier</span>
                </button>
            </div>

            <!-- Liste/Grille des séances -->
            <div id="showtimeList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                {% if showtimes is empty %}
                    <p class="text-center text-gray-300 col-span-full">Aucune séance disponible.</p>
                {% else %}
                    {% for st in showtimes %}
                        <div
                                class="flex flex-col items-center p-4 bg-white/90 rounded-xl shadow-lg
                             transform hover:scale-[1.02] hover:shadow-xl transition
                             text-gray-800"
                                data-cinema="{{ st.room.cinema.id }}"
                                data-date="{{ st.date|date('Y-m-d') }}"
                        >
                            <span class="text-2xl font-semibold">{{ st.startTime|date('H:i') }}</span>
                            <span class="text-sm text-gray-500 mb-2">{{ st.chosenLanguage }}</span>
                            <a
                                    href="{{ path('home', { id: st.id }) }}"
                                    class="mt-auto px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition
                                 font-semibold"
                            >
                                Réserver
                            </a>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    </section>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        window.addEventListener('DOMContentLoaded', () => lucide.createIcons());

        function filterByCinema(id) {
            const cards = document.querySelectorAll('#showtimeList > div');
            cards.forEach(el => {
                el.style.display = (!id || el.dataset.cinema === id) ? 'flex' : 'none';
            });
        }

        function filterByDate(date) {
            const cards = document.querySelectorAll('#showtimeList > div');
            cards.forEach(el => {
                el.style.display = (el.dataset.date === date) ? 'flex' : 'none';
            });
        }
    </script>
{% endblock %}
